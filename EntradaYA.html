<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia - Controlia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Leaflet Map CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .login-form {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .login-input {
            transition: all 0.3s ease;
        }
        .login-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="bg-blue-600 p-2 rounded-lg mr-3">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900">EntradaYA</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentTime" class="text-lg font-semibold text-gray-700"></span>
                    <button id="adminBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üë§ Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Employee Check-in/out Section -->
        <div id="employeeSection" class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Control de Asistencia</h2>
                
                <div class="flex flex-col items-center space-y-6">
                    <div class="login-form">
                        <div class="text-center mb-6">
                            <div class="bg-blue-600 p-3 rounded-full inline-block mb-4">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900">Iniciar Sesi√≥n</h3>
                            <p class="text-gray-600 mt-2">Ingresa tus credenciales para registrar asistencia</p>
                        </div>
                        
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                                <input type="text" id="loginUser" class="login-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingresa tu c√©dula/DNI" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                                <input type="password" id="loginPassword" class="login-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingresa tu contrase√±a" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors font-medium">
                                üîê Iniciar Sesi√≥n
                            </button>
                        </form>
                        
                        <div id="loginStatus" class="mt-4 text-center text-sm text-gray-500">
                            Ingresa tus credenciales para continuar
                        </div>
                    </div>

                    <div id="employeeInfo" class="hidden bg-gray-50 rounded-lg p-4 w-full max-w-md">
                        <div class="text-center">
                            <h3 id="employeeName" class="text-xl font-semibold text-gray-900"></h3>
                            <p id="employeeId" class="text-gray-600"></p>
                            <p id="lastAction" class="text-sm text-gray-500 mt-2"></p>
                            
                            <!-- GPS Status -->
                            <div id="gpsStatus" class="mt-3 p-2 rounded-lg">
                                <div class="flex items-center justify-center space-x-2">
                                    <div id="gpsIcon" class="text-lg">üìç</div>
                                    <span id="gpsText" class="text-sm font-medium">Verificando ubicaci√≥n...</span>
                                </div>
                                <div id="gpsDetails" class="text-xs text-gray-600 mt-1"></div>
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-4">
                            <button id="checkInBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                ‚úÖ Entrada
                            </button>
                            <button id="checkOutBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                üö™ Salida
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <div class="bg-red-600 p-3 rounded-full inline-block mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Acceso de Administrador</h3>
                    <p class="text-gray-600 mt-2">Ingresa la contrase√±a de administrador</p>
                </div>
                
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a de Administrador</label>
                        <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Contrase√±a de admin" required>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" id="cancelAdminLogin" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors">
                            üîì Acceder
                        </button>
                    </div>
                </form>
                
                <div id="adminLoginStatus" class="mt-4 text-center text-sm text-gray-500">
                    Contrase√±a por defecto: <strong>admin123</strong>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Admin Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-wrap gap-4">
                    <button id="showEmployees" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üë• Empleados
                    </button>
                    <button id="showRegister" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ‚ûï Registrar Empleado
                    </button>
                    <button id="showReports" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üìä Reportes
                    </button>
                    <button id="showAttendance" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üìã Asistencias
                    </button>
                    <button id="showCleanup" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üóëÔ∏è Limpieza Auto
                    </button>
                    <button id="showAdminSettings" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ‚öôÔ∏è Configuraci√≥n
                    </button>
                    <button id="showDatabase" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üóÑÔ∏è Base de Datos
                    </button>
                </div>
            </div>

            <!-- Database Management Section -->
            <div id="databaseSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üóÑÔ∏è Gesti√≥n de Base de Datos</h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Database Status -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-blue-900 mb-3">üìä Estado de la Base de Datos</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-blue-700">Total de empleados:</span>
                                <span id="dbEmployeeCount" class="font-medium text-blue-900">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Registros de asistencia:</span>
                                <span id="dbAttendanceCount" class="font-medium text-blue-900">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Tama√±o estimado:</span>
                                <span id="dbSize" class="font-medium text-blue-900">0 KB</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">√öltima actualizaci√≥n:</span>
                                <span id="dbLastUpdate" class="font-medium text-blue-900">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Actions -->
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">üíæ Respaldo de Datos</h5>
                            <p class="text-green-700 text-sm mb-3">Exporta todos los datos del sistema</p>
                            <div class="flex space-x-2">
                                <button id="exportDatabase" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üì§ Exportar BD
                                </button>
                                <button id="exportJSON" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üìÑ Exportar JSON
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-orange-800 mb-2">üì• Importar Datos</h5>
                            <p class="text-orange-700 text-sm mb-3">Restaura datos desde un archivo</p>
                            <div class="space-y-2">
                                <input type="file" id="importFile" accept=".json,.db" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                <button id="importDatabase" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üì• Importar BD
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-red-800 mb-2">üóëÔ∏è Limpiar Base de Datos</h5>
                            <p class="text-red-700 text-sm mb-3">Elimina todos los datos del sistema</p>
                            <button id="clearDatabase" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üóëÔ∏è Limpiar Todo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Database Viewer -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">üîç Explorador de Datos</h4>
                        <div class="flex space-x-2">
                            <button id="viewEmployeesDB" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                üë• Empleados
                            </button>
                            <button id="viewAttendanceDB" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                üìã Asistencias
                            </button>
                            <button id="viewConfigDB" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                ‚öôÔ∏è Configuraci√≥n
                            </button>
                        </div>
                    </div>
                    
                    <div id="databaseViewer" class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-center">Selecciona una tabla para ver los datos</p>
                    </div>
                </div>
                
                <!-- Database Integrity Check -->
                <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-yellow-900">üîß Integridad de Datos</h4>
                        <button id="checkIntegrity" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            üîç Verificar Integridad
                        </button>
                    </div>
                    <div id="integrityResults" class="text-sm text-yellow-800">
                        Haz clic en "Verificar Integridad" para analizar la base de datos
                    </div>
                </div>
            </div>

            <!-- Admin Settings Section -->
            <div id="adminSettingsSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">‚öôÔ∏è Configuraci√≥n de Administrador</h3>
                
                <div class="bg-yellow-50 p-4 rounded-lg mb-6">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h4 class="text-lg font-semibold text-yellow-900">Cambiar Contrase√±a de Administrador</h4>
                    </div>
                    <p class="text-yellow-800 text-sm mb-4">
                        Por seguridad, se recomienda cambiar la contrase√±a por defecto.
                    </p>
                    
                    <div id="defaultPasswordWarning" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                        ‚ö†Ô∏è <strong>Advertencia:</strong> Est√°s usando la contrase√±a por defecto. C√°mbiala por seguridad.
                    </div>
                </div>

                <form id="changePasswordForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a Actual</label>
                        <input type="password" id="currentAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Contrase√±a</label>
                        <input type="password" id="newAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" minlength="6" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="confirmAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" minlength="6" required>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            üîí Cambiar Contrase√±a
                        </button>
                        <button type="button" id="saveAdminChanges" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                            üíæ Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>

            <!-- Employee Registration -->
            <div id="registerSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Registrar Nuevo Empleado</h3>
                <form id="employeeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                        <input type="text" id="empName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C√©dula / DNI</label>
                        <input type="text" id="empId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: 12345678" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Departamento</label>
                        <input list="departments" id="empDept" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Escribir o seleccionar departamento" required>
                        <datalist id="departments">
                            <option value="Administraci√≥n">
                            <option value="Recursos Humanos">
                            <option value="Empleado">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Puesto</label>
                        <input type="text" id="empPosition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                        <input type="password" id="empPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contrase√±a para el empleado" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contrase√±a</label>
                        <input type="password" id="empPasswordConfirm" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Confirma la contrase√±a" required>
                    </div>
                    
                    <!-- Work Location Assignment -->
                    <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">üìç Ubicaci√≥n de Trabajo Asignada</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n o Lugar</label>
                                <input type="text" id="empAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: 18 de Julio 1234" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Departamento</label>
                                <input type="text" id="empState" value="Montevideo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Localidad o Barrio</label>
                                <input list="neighborhoods" id="empNeighborhood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Ciudad Vieja, Pocitos..." required>
                                <datalist id="neighborhoods">
                                    <option value="Ciudad Vieja">
                                    <option value="Centro">
                                    <option value="Barrio Sur">
                                    <option value="Palermo">
                                    <option value="Parque Rod√≥">
                                    <option value="Pocitos">
                                    <option value="Punta Carretas">
                                    <option value="Carrasco">
                                    <option value="Malv√≠n">
                                    <option value="Buceo">
                                    <option value="Cord√≥n">
                                    <option value="Tres Cruces">
                                    <option value="La Comercial">
                                    <option value="Aguada">
                                    <option value="Reducto">
                                    <option value="Capurro">
                                    <option value="Prado">
                                    <option value="Cerro">
                                    <option value="La Teja">
                                    <option value="Belvedere">
                                    <option value="Nuevo Par√≠s">
                                    <option value="Cerrito">
                                    <option value="Pe√±arol">
                                    <option value="Col√≥n">
                                    <option value="Lezica">
                                    <option value="Villa Garc√≠a">
                                    <option value="Sayago">
                                    <option value="Conciliaci√≥n">
                                    <option value="Paso de la Arena">
                                    <option value="Santiago V√°zquez">
                                </datalist>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Radio Permitido (metros)</label>
                                <input type="number" id="empRadius" min="10" max="1000" value="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="getCurrentLocation" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full">
                                    üìç GPS Actual
                                </button>
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="openMapSelector" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full">
                                    üó∫Ô∏è Seleccionar en Mapa
                                </button>
                            </div>
                        </div>
                        
                        <!-- GPS Status Indicator -->
                        <div id="gpsStatusIndicator" class="hidden mt-3 p-3 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div id="gpsStatusIcon" class="text-lg">üìç</div>
                                <div>
                                    <div id="gpsStatusText" class="text-sm font-medium"></div>
                                    <div id="gpsCoordinates" class="text-xs text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden fields for GPS coordinates -->
                        <input type="hidden" id="empLatitude">
                        <input type="hidden" id="empLongitude">
                        <div class="mt-3">
                            <p class="text-xs text-gray-600">
                                üí° Tip: Completa la direcci√≥n manualmente o usa "Ubicaci√≥n Actual" mientras est√©s en el lugar de trabajo del empleado
                            </p>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                            ‚úÖ Registrar Empleado
                        </button>
                    </div>
                </form>
            </div>

            <!-- Employee List -->
            <div id="employeeList" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Lista de Empleados</h3>
                    <input type="text" id="searchEmployee" placeholder="Buscar empleado..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div id="employeeTable" class="overflow-x-auto">
                    <!-- Employee table will be populated here -->
                </div>
            </div>

            <!-- Attendance Records -->
            <div id="attendanceSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Registros de Asistencia</h3>
                    <div class="flex space-x-2">
                        <input type="date" id="filterDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <select id="filterEmployee" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos los empleados</option>
                        </select>
                    </div>
                </div>
                <div id="attendanceTable" class="overflow-x-auto">
                    <!-- Attendance table will be populated here -->
                </div>
            </div>

            <!-- Auto-cleanup Configuration -->
            <div id="cleanupSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üóëÔ∏è Configuraci√≥n de Limpieza Autom√°tica</h3>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h4 class="text-lg font-semibold text-blue-900">Limpieza Autom√°tica de Registros</h4>
                    </div>
                    <p class="text-blue-800 text-sm">
                        Los registros de asistencia se eliminar√°n autom√°ticamente despu√©s del tiempo configurado para mantener el sistema optimizado.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Eliminar registros despu√©s de:</label>
                            <select id="autoCleanupPeriod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="0">Desactivado</option>
                                <option value="30">30 d√≠as</option>
                                <option value="60">60 d√≠as</option>
                                <option value="90" selected>90 d√≠as (3 meses)</option>
                                <option value="180">180 d√≠as (6 meses)</option>
                                <option value="365">365 d√≠as (1 a√±o)</option>
                                <option value="730">730 d√≠as (2 a√±os)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">√öltima limpieza autom√°tica:</label>
                            <div id="lastCleanupDate" class="px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm text-gray-600">
                                Nunca ejecutada
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥xima limpieza programada:</label>
                            <div id="nextCleanupDate" class="px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm text-gray-600">
                                No programada
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-yellow-800 mb-2">üìä Estad√≠sticas de Registros</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Total de registros:</span>
                                    <span id="totalRecords" class="font-medium text-yellow-900">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Registros antiguos:</span>
                                    <span id="oldRecords" class="font-medium text-yellow-900">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Espacio estimado:</span>
                                    <span id="estimatedSize" class="font-medium text-yellow-900">0 KB</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button id="saveCleanupConfig" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                ‚úÖ Guardar Configuraci√≥n
                            </button>
                            <button id="runCleanupNow" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                                üßπ Ejecutar Limpieza Ahora
                            </button>
                            <button id="previewCleanup" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                üëÅÔ∏è Vista Previa de Limpieza
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="cleanupPreview" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
                    <h5 class="font-semibold text-gray-900 mb-3">Vista Previa de Registros a Eliminar</h5>
                    <div id="cleanupPreviewContent"></div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="hidden bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Generar Reportes</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mes</label>
                        <select id="reportMonth" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">A√±o</label>
                        <select id="reportYear" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Empleado</label>
                        <select id="reportEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos los empleados</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="generateReport" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                        üìä Generar Reporte
                    </button>
                    <button id="downloadPDF" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
                        üìÑ Descargar PDF
                    </button>
                    <button id="deleteYearRecords" class="bg-red-800 hover:bg-red-900 text-white px-6 py-2 rounded-lg transition-colors border-2 border-red-600">
                        üóëÔ∏è Eliminar Registros del A√±o
                    </button>
                </div>
                <div id="reportPreview" class="mt-6 hidden">
                    <!-- Report preview will be shown here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Modal -->
    <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div id="modalIcon" class="text-2xl mr-3">‚ÑπÔ∏è</div>
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Informaci√≥n</h3>
            </div>
            <div id="modalMessage" class="mb-6 text-gray-700"></div>
            <div class="flex justify-end space-x-3">
                <button id="modalCancel" class="hidden px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancelar</button>
                <button id="modalConfirm" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Map Selector Modal -->
    <div id="mapSelectorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">üó∫Ô∏è Seleccionar Ubicaci√≥n en el Mapa</h3>
                <button id="closeMapSelector" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-600 text-sm mb-3">Haz clic en el mapa para seleccionar la ubicaci√≥n de trabajo del empleado</p>
                
                <!-- Map Navigation Buttons -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="centerMapMontevideo" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        üèõÔ∏è Centro de Montevideo
                    </button>
                    <button id="centerMapPocitos" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm">
                        üèñÔ∏è Pocitos
                    </button>
                    <button id="centerMapCarrasco" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ‚úàÔ∏è Carrasco
                    </button>
                </div>
            </div>
            
            <!-- Map Container -->
            <div id="mapContainer" class="w-full h-96 bg-gray-100 rounded-lg border-2 border-gray-300 mb-4 relative">
                <div id="leafletMap" class="w-full h-full rounded-lg"></div>
                <div id="mapLoadingIndicator" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-lg">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                        <p class="text-gray-600">Cargando mapa GPS...</p>
                    </div>
                </div>
            </div>
            
            <!-- Selected Location Info -->
            <div id="selectedLocationInfo" class="hidden bg-green-50 p-4 rounded-lg mb-4">
                <h4 class="font-semibold text-green-800 mb-2">üìç Ubicaci√≥n Seleccionada</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-green-700 font-medium">Coordenadas:</span>
                        <span id="selectedCoords" class="text-green-900"></span>
                    </div>
                    <div>
                        <span class="text-green-700 font-medium">Direcci√≥n estimada:</span>
                        <span id="selectedAddress" class="text-green-900"></span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3">
                <button id="cancelMapSelection" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button id="confirmMapSelection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" disabled>
                    ‚úÖ Confirmar Ubicaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span id="loadingText" class="text-gray-700">Cargando...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let currentEmployee = null;
        let isAdminMode = false;
        let cleanupConfig = JSON.parse(localStorage.getItem('cleanupConfig')) || {
            enabled: true,
            periodDays: 90,
            lastCleanup: null,
            nextCleanup: null
        };
        let cleanupInterval = null;
        
        // Map variables
        let mapInstance = null;
        let selectedLocation = null;
        
        // Admin configuration
        let adminConfig = JSON.parse(localStorage.getItem('adminConfig')) || {
            password: 'admin123',
            isDefault: true
        };

        // Security Functions
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Modal Functions
        function showModal(message, title = 'Informaci√≥n', type = 'info') {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            const modalCancel = document.getElementById('modalCancel');
            const modalConfirm = document.getElementById('modalConfirm');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCancel.classList.add('hidden');
            modalConfirm.textContent = 'Aceptar';
            
            // Set icon and colors based on type
            switch(type) {
                case 'success':
                    modalIcon.textContent = '‚úÖ';
                    modalTitle.className = 'text-lg font-semibold text-green-700';
                    break;
                case 'error':
                    modalIcon.textContent = '‚ùå';
                    modalTitle.className = 'text-lg font-semibold text-red-700';
                    break;
                case 'warning':
                    modalIcon.textContent = '‚ö†Ô∏è';
                    modalTitle.className = 'text-lg font-semibold text-yellow-700';
                    break;
                default:
                    modalIcon.textContent = '‚ÑπÔ∏è';
                    modalTitle.className = 'text-lg font-semibold text-blue-700';
            }
            
            modal.classList.remove('hidden');
            
            return new Promise((resolve) => {
                modalConfirm.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
            });
        }

        function showConfirmModal(message, title = 'Confirmaci√≥n') {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            const modalCancel = document.getElementById('modalCancel');
            const modalConfirm = document.getElementById('modalConfirm');
            
            modalTitle.textContent = title;
            modalTitle.className = 'text-lg font-semibold text-orange-700';
            modalMessage.textContent = message;
            modalIcon.textContent = '‚ùì';
            modalCancel.classList.remove('hidden');
            modalConfirm.textContent = 'Confirmar';
            
            modal.classList.remove('hidden');
            
            return new Promise((resolve) => {
                modalConfirm.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                modalCancel.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        function showLoading(text = 'Cargando...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Admin Login Functions
        function showAdminLogin() {
            const modal = document.getElementById('adminLoginModal');
            const status = document.getElementById('adminLoginStatus');
            
            if (adminConfig.isDefault) {
                status.innerHTML = 'Contrase√±a por defecto: <strong>admin123</strong>';
                status.className = 'mt-4 text-center text-sm text-gray-500';
            } else {
                status.textContent = 'Ingresa tu contrase√±a personalizada';
                status.className = 'mt-4 text-center text-sm text-blue-600';
            }
            
            modal.classList.remove('hidden');
            document.getElementById('adminPassword').focus();
        }

        function hideAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginStatus').textContent = '';
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const status = document.getElementById('adminLoginStatus');
            
            showLoading('Verificando acceso...');
            
            try {
                let passwordMatch = false;
                
                if (adminConfig.password.length === 64) {
                    // Hashed password
                    const hashedInput = await hashPassword(password);
                    passwordMatch = adminConfig.password === hashedInput;
                } else {
                    // Plain text password
                    passwordMatch = adminConfig.password === password;
                    
                    // Upgrade to hashed password
                    if (passwordMatch) {
                        adminConfig.password = await hashPassword(password);
                        localStorage.setItem('adminConfig', JSON.stringify(adminConfig));
                    }
                }
                
                if (passwordMatch) {
                    hideAdminLogin();
                    activateAdminMode();
                } else {
                    status.textContent = 'Contrase√±a incorrecta';
                    status.className = 'mt-4 text-center text-sm text-red-600';
                    setTimeout(() => {
                        if (adminConfig.isDefault) {
                            status.innerHTML = 'Contrase√±a por defecto: <strong>admin123</strong>';
                            status.className = 'mt-4 text-center text-sm text-gray-500';
                        } else {
                            status.textContent = 'Ingresa tu contrase√±a personalizada';
                            status.className = 'mt-4 text-center text-sm text-blue-600';
                        }
                    }, 3000);
                }
            } catch (error) {
                await showModal('Error al verificar contrase√±a de administrador', 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        function activateAdminMode() {
            isAdminMode = true;
            const adminPanel = document.getElementById('adminPanel');
            const employeeSection = document.getElementById('employeeSection');
            const adminBtn = document.getElementById('adminBtn');
            
            adminPanel.classList.remove('hidden');
            employeeSection.classList.add('hidden');
            adminBtn.textContent = 'üë§ Empleado';
            adminBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            adminBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            showSection('employeeList');
        }

        async function changeAdminPassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentAdminPassword').value;
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (newPassword !== confirmPassword) {
                await showModal('Las contrase√±as nuevas no coinciden', 'Error de Validaci√≥n', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                await showModal('La nueva contrase√±a debe tener al menos 6 caracteres', 'Error de Validaci√≥n', 'error');
                return;
            }
            
            showLoading('Cambiando contrase√±a...');
            
            try {
                // Verify current password
                let currentPasswordMatch = false;
                
                if (adminConfig.password.length === 64) {
                    const hashedCurrent = await hashPassword(currentPassword);
                    currentPasswordMatch = adminConfig.password === hashedCurrent;
                } else {
                    currentPasswordMatch = adminConfig.password === currentPassword;
                }
                
                if (!currentPasswordMatch) {
                    await showModal('La contrase√±a actual es incorrecta', 'Error de Autenticaci√≥n', 'error');
                    return;
                }
                
                // Set new password
                adminConfig.password = await hashPassword(newPassword);
                adminConfig.isDefault = false;
                localStorage.setItem('adminConfig', JSON.stringify(adminConfig));
                
                // Clear form
                document.getElementById('changePasswordForm').reset();
                
                // Update UI
                updateAdminSettingsUI();
                
                await showModal('Contrase√±a de administrador cambiada correctamente', 'Contrase√±a Actualizada', 'success');
                
            } catch (error) {
                await showModal('Error al cambiar contrase√±a: ' + error.message, 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateAdminSettingsUI() {
            const defaultWarning = document.getElementById('defaultPasswordWarning');
            
            if (adminConfig.isDefault) {
                defaultWarning.classList.remove('hidden');
            } else {
                defaultWarning.classList.add('hidden');
            }
        }

        async function saveAdminChanges() {
            showLoading('Guardando cambios...');
            
            try {
                // Save all current data to localStorage
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                localStorage.setItem('adminConfig', JSON.stringify(adminConfig));
                localStorage.setItem('cleanupConfig', JSON.stringify(cleanupConfig));
                
                await showModal('‚úÖ Todos los cambios han sido guardados correctamente', 'Cambios Guardados', 'success');
            } catch (error) {
                await showModal('‚ùå Error al guardar cambios: ' + error.message, 'Error al Guardar', 'error');
            } finally {
                hideLoading();
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            populateYearSelect();
            setCurrentMonth();
            loadEmployeeSelects();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize auto-cleanup system
            initializeAutoCleanup();
            
            // Update admin settings UI
            updateAdminSettingsUI();
            
            // Load initial data
            if (employees.length === 0) {
                // Add sample employees for demo
                addSampleData();
            }
        });

        // GPS Location Functions
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no soportada por este navegador'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    position => resolve(position),
                    error => {
                        let errorMessage = 'Error desconocido';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Permiso de ubicaci√≥n denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Tiempo de espera agotado';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        async function verifyEmployeeLocation(employee) {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsIcon = document.getElementById('gpsIcon');
            const gpsText = document.getElementById('gpsText');
            const gpsDetails = document.getElementById('gpsDetails');
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');

            // Reset status
            gpsStatus.className = 'mt-3 p-2 rounded-lg bg-yellow-100';
            gpsIcon.textContent = 'üìç';
            gpsText.textContent = 'Verificando ubicaci√≥n...';
            gpsDetails.textContent = '';
            checkInBtn.disabled = true;
            checkOutBtn.disabled = true;

            try {
                // Check if employee has work location assigned
                if (!employee.workLocation) {
                    gpsStatus.className = 'mt-3 p-2 rounded-lg bg-red-100';
                    gpsIcon.textContent = '‚ùå';
                    gpsText.textContent = 'Sin ubicaci√≥n asignada';
                    gpsDetails.textContent = 'Contacta al administrador para asignar tu ubicaci√≥n de trabajo';
                    return;
                }

                // Set timeout for GPS verification
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Tiempo de espera agotado')), 8000);
                });

                const position = await Promise.race([getCurrentPosition(), timeoutPromise]);
                
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const workLat = employee.workLocation.latitude;
                const workLon = employee.workLocation.longitude;
                const allowedRadius = employee.workLocation.radius;

                const distance = calculateDistance(userLat, userLon, workLat, workLon);

                if (distance <= allowedRadius) {
                    // Within allowed area
                    gpsStatus.className = 'mt-3 p-2 rounded-lg bg-green-100';
                    gpsIcon.textContent = '‚úÖ';
                    gpsText.textContent = 'Ubicaci√≥n verificada';
                    gpsDetails.textContent = `Est√°s a ${Math.round(distance)}m de tu lugar de trabajo`;
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = false;
                } else {
                    // Outside allowed area
                    gpsStatus.className = 'mt-3 p-2 rounded-lg bg-red-100';
                    gpsIcon.textContent = 'üö´';
                    gpsText.textContent = 'Fuera del √°rea permitida';
                    gpsDetails.textContent = `Est√°s a ${Math.round(distance)}m de tu lugar de trabajo (m√°ximo: ${allowedRadius}m)`;
                }

            } catch (error) {
                gpsStatus.className = 'mt-3 p-2 rounded-lg bg-orange-100';
                gpsIcon.textContent = '‚ö†Ô∏è';
                gpsText.textContent = 'GPS no disponible';
                gpsDetails.textContent = 'Puedes registrar asistencia sin verificaci√≥n GPS';
                // Enable buttons even if GPS fails
                checkInBtn.disabled = false;
                checkOutBtn.disabled = false;
            }
        }

        function setupLocationButton() {
            document.getElementById('getCurrentLocation').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    await showModal('Tu navegador no soporta geolocalizaci√≥n. Por favor ingresa la direcci√≥n manualmente.', 'Geolocalizaci√≥n No Disponible', 'warning');
                    return;
                }
                
                button.disabled = true;
                button.textContent = 'üìç Obteniendo ubicaci√≥n...';
                
                // Show GPS status indicator immediately
                const statusIndicator = document.getElementById('gpsStatusIndicator');
                const statusIcon = document.getElementById('gpsStatusIcon');
                const statusText = document.getElementById('gpsStatusText');
                const coordinates = document.getElementById('gpsCoordinates');
                
                statusIndicator.className = 'mt-3 p-3 rounded-lg bg-blue-100 border border-blue-200';
                statusIcon.textContent = 'üìç';
                statusText.textContent = 'Obteniendo ubicaci√≥n GPS...';
                coordinates.textContent = 'Esperando respuesta del GPS...';
                statusIndicator.classList.remove('hidden');
                
                try {
                    // Request location with timeout handling
                    const position = await new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => {
                            reject(new Error('Tiempo de espera agotado (10 segundos). Intenta nuevamente.'));
                        }, 10000);
                        
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                clearTimeout(timeoutId);
                                resolve(pos);
                            },
                            (error) => {
                                clearTimeout(timeoutId);
                                let errorMessage = 'Error desconocido al obtener ubicaci√≥n';
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMessage = 'Permiso de ubicaci√≥n denegado. Por favor permite el acceso a tu ubicaci√≥n en el navegador.';
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMessage = 'Ubicaci√≥n no disponible. Verifica que tengas GPS activado y est√©s en un lugar con buena se√±al.';
                                        break;
                                    case error.TIMEOUT:
                                        errorMessage = 'Tiempo de espera agotado. Intenta nuevamente.';
                                        break;
                                }
                                reject(new Error(errorMessage));
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 8000,
                                maximumAge: 30000
                            }
                        );
                    });
                    
                    // Store GPS coordinates in hidden fields with high precision
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    document.getElementById('empLatitude').value = lat;
                    document.getElementById('empLongitude').value = lng;
                    
                    // Update address fields with GPS info
                    document.getElementById('empAddress').value = `GPS: ${lat}, ${lng}`;
                    
                    // Set a default neighborhood if empty
                    const neighborhoodField = document.getElementById('empNeighborhood');
                    if (!neighborhoodField.value.trim()) {
                        neighborhoodField.value = 'Centro'; // Default neighborhood
                    }
                    
                    // Update GPS status indicator to success
                    statusIndicator.className = 'mt-3 p-3 rounded-lg bg-green-100 border border-green-200';
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = 'Ubicaci√≥n GPS capturada correctamente';
                    coordinates.textContent = `Coordenadas: ${lat}, ${lng} (¬±${Math.round(position.coords.accuracy)}m)`;
                    
                    button.textContent = '‚úÖ Ubicaci√≥n GPS obtenida';
                    button.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full';
                    
                    await showModal(`¬°Ubicaci√≥n GPS obtenida correctamente!\n\nCoordenadas: ${lat}, ${lng}\nPrecisi√≥n: ¬±${Math.round(position.coords.accuracy)} metros\n\nPuedes editar la direcci√≥n si lo deseas antes de registrar el empleado.`, 'Ubicaci√≥n Obtenida', 'success');
                    
                    // Reset button after 5 seconds
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full';
                        button.disabled = false;
                    }, 5000);
                    
                } catch (error) {
                    console.error('GPS Error:', error);
                    
                    // Update GPS status indicator to error
                    statusIndicator.className = 'mt-3 p-3 rounded-lg bg-red-100 border border-red-200';
                    statusIcon.textContent = '‚ùå';
                    statusText.textContent = 'Error al obtener ubicaci√≥n';
                    coordinates.textContent = error.message;
                    
                    await showModal(error.message + '\n\nPuedes ingresar la direcci√≥n manualmente en los campos de arriba.', 'Error GPS', 'error');
                    
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function setupEventListeners() {
            // Admin toggle
            document.getElementById('adminBtn').addEventListener('click', toggleAdminMode);
            
            // Admin login
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('cancelAdminLogin').addEventListener('click', hideAdminLogin);
            
            // Admin password change
            document.getElementById('changePasswordForm').addEventListener('submit', changeAdminPassword);
            document.getElementById('saveAdminChanges').addEventListener('click', saveAdminChanges);
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Check in/out buttons
            document.getElementById('checkInBtn').addEventListener('click', () => recordAttendance('in'));
            document.getElementById('checkOutBtn').addEventListener('click', () => recordAttendance('out'));
            
            // Admin navigation
            document.getElementById('showEmployees').addEventListener('click', () => showSection('employeeList'));
            document.getElementById('showRegister').addEventListener('click', () => showSection('registerSection'));
            document.getElementById('showReports').addEventListener('click', () => showSection('reportsSection'));
            document.getElementById('showAttendance').addEventListener('click', () => showSection('attendanceSection'));
            document.getElementById('showCleanup').addEventListener('click', () => showSection('cleanupSection'));
            document.getElementById('showAdminSettings').addEventListener('click', () => showSection('adminSettingsSection'));
            document.getElementById('showDatabase').addEventListener('click', () => showSection('databaseSection'));
            
            // Employee registration
            document.getElementById('employeeForm').addEventListener('submit', registerEmployee);
            
            // GPS location button
            setupLocationButton();
            
            // Map selector
            setupMapSelector();
            
            // Search and filters
            document.getElementById('searchEmployee').addEventListener('input', filterEmployees);
            document.getElementById('filterDate').addEventListener('change', filterAttendance);
            document.getElementById('filterEmployee').addEventListener('change', filterAttendance);
            
            // Reports
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('downloadPDF').addEventListener('click', downloadPDF);
            document.getElementById('deleteYearRecords').addEventListener('click', deleteYearRecords);
            
            // Auto-cleanup
            document.getElementById('saveCleanupConfig').addEventListener('click', saveCleanupConfig);
            document.getElementById('runCleanupNow').addEventListener('click', runCleanupNow);
            document.getElementById('previewCleanup').addEventListener('click', previewCleanup);
            document.getElementById('autoCleanupPeriod').addEventListener('change', updateCleanupStats);
            
            // Database management
            document.getElementById('exportDatabase').addEventListener('click', exportDatabase);
            document.getElementById('exportJSON').addEventListener('click', exportJSON);
            document.getElementById('importDatabase').addEventListener('click', importDatabase);
            document.getElementById('clearDatabase').addEventListener('click', clearDatabase);
            document.getElementById('viewEmployeesDB').addEventListener('click', () => viewDatabaseTable('employees'));
            document.getElementById('viewAttendanceDB').addEventListener('click', () => viewDatabaseTable('attendance'));
            document.getElementById('viewConfigDB').addEventListener('click', () => viewDatabaseTable('config'));
            document.getElementById('checkIntegrity').addEventListener('click', checkDatabaseIntegrity);
        }

        function toggleAdminMode() {
            if (isAdminMode) {
                // Exit admin mode
                isAdminMode = false;
                const adminPanel = document.getElementById('adminPanel');
                const employeeSection = document.getElementById('employeeSection');
                const adminBtn = document.getElementById('adminBtn');
                
                adminPanel.classList.add('hidden');
                employeeSection.classList.remove('hidden');
                adminBtn.textContent = 'üë§ Admin';
                adminBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                adminBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                resetEmployeeSection();
            } else {
                // Request admin access
                showAdminLogin();
            }
        }

        function showSection(sectionId) {
            const sections = ['employeeList', 'registerSection', 'reportsSection', 'attendanceSection', 'cleanupSection', 'adminSettingsSection', 'databaseSection'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'employeeList') {
                displayEmployees();
            } else if (sectionId === 'attendanceSection') {
                displayAttendanceRecords();
            } else if (sectionId === 'cleanupSection') {
                loadCleanupSection();
            } else if (sectionId === 'adminSettingsSection') {
                updateAdminSettingsUI();
            } else if (sectionId === 'databaseSection') {
                loadDatabaseSection();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            const status = document.getElementById('loginStatus');
            
            showLoading('Verificando credenciales...');
            
            try {
                // Find employee by ID
                const employee = employees.find(emp => emp.id === userId);
                
                if (employee) {
                    // Check if password is hashed or plain text (for backward compatibility)
                    let passwordMatch = false;
                    
                    if (employee.password.length === 64) {
                        // Hashed password
                        const hashedInput = await hashPassword(password);
                        passwordMatch = employee.password === hashedInput;
                    } else {
                        // Plain text password (legacy)
                        passwordMatch = employee.password === password;
                        
                        // Upgrade to hashed password
                        if (passwordMatch) {
                            employee.password = await hashPassword(password);
                            localStorage.setItem('employees', JSON.stringify(employees));
                        }
                    }
                    
                    if (passwordMatch) {
                        currentEmployee = employee;
                        showEmployeeInfo(employee);
                        status.textContent = 'Inicio de sesi√≥n exitoso';
                        status.classList.add('text-green-600');
                        
                        // Clear form
                        document.getElementById('loginForm').reset();
                    } else {
                        status.textContent = 'Usuario o contrase√±a incorrectos';
                        status.classList.add('text-red-600');
                        setTimeout(() => {
                            status.textContent = 'Ingresa tus credenciales para continuar';
                            status.classList.remove('text-red-600');
                        }, 3000);
                    }
                } else {
                    status.textContent = 'Usuario o contrase√±a incorrectos';
                    status.classList.add('text-red-600');
                    setTimeout(() => {
                        status.textContent = 'Ingresa tus credenciales para continuar';
                        status.classList.remove('text-red-600');
                    }, 3000);
                }
            } catch (error) {
                await showModal('Error al verificar credenciales', 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        function showEmployeeInfo(employee) {
            const infoDiv = document.getElementById('employeeInfo');
            const nameEl = document.getElementById('employeeName');
            const idEl = document.getElementById('employeeId');
            const lastActionEl = document.getElementById('lastAction');
            
            nameEl.textContent = employee.name;
            idEl.textContent = `C√©dula: ${employee.id} - ${employee.department}`;
            
            const lastRecord = getLastAttendanceRecord(employee.id);
            if (lastRecord) {
                lastActionEl.textContent = `√öltima acci√≥n: ${lastRecord.type === 'in' ? 'Entrada' : 'Salida'} - ${new Date(lastRecord.timestamp).toLocaleString('es-ES')}`;
            } else {
                lastActionEl.textContent = 'Sin registros previos';
            }
            
            infoDiv.classList.remove('hidden');
            
            // Start GPS verification
            verifyEmployeeLocation(employee);
        }

        function getLastAttendanceRecord(employeeId) {
            const records = attendanceRecords.filter(r => r.employeeId === employeeId);
            return records.length > 0 ? records[records.length - 1] : null;
        }

        async function recordAttendance(type) {
            if (!currentEmployee) return;
            
            showLoading(`Registrando ${type === 'in' ? 'entrada' : 'salida'}...`);
            
            try {
                let location = null;
                
                // Try to get current location, but don't fail if it's not available
                try {
                    const position = await Promise.race([
                        getCurrentPosition(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('GPS timeout')), 5000))
                    ]);
                    
                    location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                } catch (gpsError) {
                    console.log('GPS not available for record:', gpsError.message);
                    // Use work location as fallback
                    if (currentEmployee.workLocation) {
                        location = {
                            latitude: currentEmployee.workLocation.latitude,
                            longitude: currentEmployee.workLocation.longitude,
                            accuracy: 100
                        };
                    }
                }
                
                const record = {
                    id: Date.now() + Math.random(), // Ensure unique ID
                    employeeId: currentEmployee.id,
                    employeeName: currentEmployee.name,
                    type: type,
                    timestamp: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0],
                    location: location
                };
                
                attendanceRecords.push(record);
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                
                // Hide loading immediately after saving
                hideLoading();
                
                // Show success message
                const gpsText = document.getElementById('gpsText');
                const gpsIcon = document.getElementById('gpsIcon');
                gpsIcon.textContent = '‚úÖ';
                gpsText.textContent = `${type === 'in' ? 'Entrada' : 'Salida'} registrada correctamente`;
                
                await showModal(`${type === 'in' ? 'Entrada' : 'Salida'} registrada correctamente a las ${new Date().toLocaleTimeString('es-ES')}`, 'Registro Exitoso', 'success');
                
                // Reset after modal is closed
                resetEmployeeSection();
                
            } catch (error) {
                console.error('Error recording attendance:', error);
                hideLoading();
                await showModal('Error al registrar asistencia: ' + error.message, 'Error de Registro', 'error');
            }
        }

        function resetEmployeeSection() {
            document.getElementById('employeeInfo').classList.add('hidden');
            document.getElementById('loginStatus').textContent = 'Ingresa tus credenciales para continuar';
            document.getElementById('loginStatus').classList.remove('text-green-600', 'text-red-600');
            document.getElementById('loginForm').reset();
            currentEmployee = null;
        }

        async function registerEmployee(e) {
            e.preventDefault();
            
            const password = document.getElementById('empPassword').value;
            const passwordConfirm = document.getElementById('empPasswordConfirm').value;
            const address = document.getElementById('empAddress').value;
            const neighborhood = document.getElementById('empNeighborhood').value;
            const latitude = parseFloat(document.getElementById('empLatitude').value);
            const longitude = parseFloat(document.getElementById('empLongitude').value);
            const radius = parseInt(document.getElementById('empRadius').value);
            const employeeId = document.getElementById('empId').value;
            
            if (password !== passwordConfirm) {
                await showModal('Las contrase√±as no coinciden', 'Error de Validaci√≥n', 'error');
                return;
            }
            
            if (password.length < 4) {
                await showModal('La contrase√±a debe tener al menos 4 caracteres', 'Error de Validaci√≥n', 'error');
                return;
            }
            
            if (!address.trim() || !neighborhood.trim()) {
                await showModal('Por favor completa la direcci√≥n y el barrio', 'Campos Requeridos', 'warning');
                return;
            }
            
            // Check if employee ID already exists
            if (employees.find(emp => emp.id === employeeId)) {
                await showModal('Ya existe un empleado con esta c√©dula/DNI', 'ID Duplicado', 'error');
                return;
            }
            
            if (radius < 10 || radius > 1000) {
                await showModal('El radio debe estar entre 10 y 1000 metros', 'Error de Validaci√≥n', 'error');
                return;
            }
            
            showLoading('Registrando empleado...');
            
            try {
                // If GPS coordinates are not available, use default Montevideo coordinates
                let finalLatitude = latitude;
                let finalLongitude = longitude;
                let showDefaultLocationWarning = false;
                
                if (isNaN(latitude) || isNaN(longitude)) {
                    // Default coordinates for Montevideo center (Plaza Independencia)
                    finalLatitude = -34.9058;
                    finalLongitude = -56.1913;
                    showDefaultLocationWarning = true;
                }
                
                // Hash the password
                const hashedPassword = await hashPassword(password);
                
                const employee = {
                    id: employeeId,
                    name: document.getElementById('empName').value,
                    department: document.getElementById('empDept').value,
                    position: document.getElementById('empPosition').value,
                    password: hashedPassword,
                    workLocation: {
                        address: address,
                        neighborhood: neighborhood,
                        department: 'Montevideo',
                        latitude: finalLatitude,
                        longitude: finalLongitude,
                        radius: radius
                    },
                    registrationDate: new Date().toISOString()
                };
                
                employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // Hide loading immediately after saving
                hideLoading();
                
                // Reset form including GPS coordinates
                document.getElementById('employeeForm').reset();
                document.getElementById('empRadius').value = 100; // Reset to default
                document.getElementById('empState').value = 'Montevideo'; // Reset department
                document.getElementById('empLatitude').value = ''; // Clear GPS coordinates
                document.getElementById('empLongitude').value = ''; // Clear GPS coordinates
                
                // Hide GPS status indicator
                document.getElementById('gpsStatusIndicator').classList.add('hidden');
                
                // Update employee selects
                loadEmployeeSelects();
                
                // Show appropriate success message
                if (showDefaultLocationWarning) {
                    await showModal('Empleado registrado correctamente. Se usaron coordenadas por defecto del centro de Montevideo. Para mayor precisi√≥n, usa "Ubicaci√≥n Actual" desde el lugar de trabajo.', 'Registro Exitoso', 'success');
                } else {
                    await showModal('Empleado registrado correctamente con ubicaci√≥n GPS asignada', 'Registro Exitoso', 'success');
                }
                
            } catch (error) {
                console.error('Error registering employee:', error);
                hideLoading();
                await showModal('Error al registrar empleado: ' + error.message, 'Error', 'error');
            }
        }

        function displayEmployees(employeeList = employees) {
            const tableContainer = document.getElementById('employeeTable');
            
            if (employeeList.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay empleados registrados</p>';
                return;
            }
            
            const html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√©dula/DNI</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Puesto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${employeeList.map(emp => `
                            <tr>
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${emp.id}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${emp.name}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${emp.department}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${emp.position}</td>
                                <td class="px-6 py-4 text-sm">
                                    <button onclick="deleteEmployeeConfirm('${emp.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = html;
        }

        async function deleteEmployeeConfirm(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const confirmed = await showConfirmModal(`¬øEst√° seguro de que desea eliminar al empleado ${employee.name} (${employee.id})?`, 'Confirmar Eliminaci√≥n');
            
            if (confirmed) {
                showLoading('Eliminando empleado...');
                
                try {
                    // Remove employee from array
                    const originalLength = employees.length;
                    employees = employees.filter(emp => emp.id !== employeeId);
                    
                    if (employees.length < originalLength) {
                        // Save updated employees list
                        localStorage.setItem('employees', JSON.stringify(employees));
                        
                        // Refresh displays
                        displayEmployees();
                        loadEmployeeSelects();
                        
                        await showModal(`Empleado ${employee.name} eliminado correctamente`, 'Eliminaci√≥n Exitosa', 'success');
                    } else {
                        await showModal('No se pudo eliminar el empleado', 'Error de Eliminaci√≥n', 'error');
                    }
                } catch (error) {
                    await showModal('Error al eliminar empleado: ' + error.message, 'Error', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        async function deleteYearRecords() {
            const year = parseInt(document.getElementById('reportYear').value);
            if (!year) {
                await showModal('Por favor selecciona un a√±o v√°lido', 'A√±o Requerido', 'warning');
                return;
            }
            
            const recordsToDelete = attendanceRecords.filter(record => 
                new Date(record.timestamp).getFullYear() === year
            );
            
            if (recordsToDelete.length === 0) {
                await showModal(`No hay registros para el a√±o ${year}`, 'Sin Registros', 'info');
                return;
            }
            
            const firstConfirm = await showConfirmModal(`‚ö†Ô∏è Se eliminar√°n ${recordsToDelete.length} registros del a√±o ${year}. ¬øContinuar?`, 'Confirmar Eliminaci√≥n');
            
            if (firstConfirm) {
                const finalConfirm = await showConfirmModal(`üö® CONFIRMACI√ìN FINAL: ¬øEliminar TODOS los registros del a√±o ${year}?`, 'Confirmaci√≥n Final');
                
                if (finalConfirm) {
                    showLoading('Eliminando registros...');
                    
                    try {
                        attendanceRecords = attendanceRecords.filter(record => 
                            new Date(record.timestamp).getFullYear() !== year
                        );
                        localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                        displayAttendanceRecords();
                        document.getElementById('reportPreview').classList.add('hidden');
                        
                        await showModal(`‚úÖ Eliminados ${recordsToDelete.length} registros del a√±o ${year}`, 'Eliminaci√≥n Exitosa', 'success');
                    } catch (error) {
                        await showModal('Error al eliminar registros: ' + error.message, 'Error', 'error');
                    } finally {
                        hideLoading();
                    }
                }
            }
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.department.toLowerCase().includes(searchTerm)
            );
            displayEmployees(filtered);
        }

        function displayAttendanceRecords(recordList = attendanceRecords) {
            const tableContainer = document.getElementById('attendanceTable');
            
            if (recordList.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay registros de asistencia</p>';
                return;
            }
            
            const sortedRecords = [...recordList].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empleado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√©dula/DNI</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${sortedRecords.map(record => {
                            const date = new Date(record.timestamp);
                            return `
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900">${date.toLocaleDateString('es-ES')}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900">${date.toLocaleTimeString('es-ES')}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900">${record.employeeName}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900">${record.employeeId}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 text-xs font-semibold rounded-full ${record.type === 'in' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${record.type === 'in' ? '‚úÖ Entrada' : 'üö™ Salida'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = html;
        }

        function filterAttendance() {
            const filterDate = document.getElementById('filterDate').value;
            const filterEmployee = document.getElementById('filterEmployee').value;
            
            let filtered = [...attendanceRecords];
            if (filterDate) filtered = filtered.filter(r => r.date === filterDate);
            if (filterEmployee) filtered = filtered.filter(r => r.employeeId === filterEmployee);
            
            displayAttendanceRecords(filtered);
        }

        function populateYearSelect() {
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function setCurrentMonth() {
            const monthSelect = document.getElementById('reportMonth');
            monthSelect.value = new Date().getMonth();
        }

        function loadEmployeeSelects() {
            const selects = ['filterEmployee', 'reportEmployee'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear existing options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.id})`;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function generateReport() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const employeeId = document.getElementById('reportEmployee').value;
            
            const reportData = generateReportData(month, year, employeeId);
            displayReportPreview(reportData, month, year, employeeId);
        }

        function generateReportData(month, year, employeeId) {
            let filteredRecords = attendanceRecords.filter(record => {
                const recordDate = new Date(record.timestamp);
                const matchesMonth = recordDate.getMonth() === month;
                const matchesYear = recordDate.getFullYear() === year;
                const matchesEmployee = !employeeId || record.employeeId === employeeId;
                
                return matchesMonth && matchesYear && matchesEmployee;
            });
            
            // Group records by employee and date
            const groupedData = {};
            
            filteredRecords.forEach(record => {
                const key = `${record.employeeId}_${record.date}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        employeeId: record.employeeId,
                        employeeName: record.employeeName,
                        date: record.date,
                        checkIn: null,
                        checkOut: null,
                        hoursWorked: 0
                    };
                }
                
                if (record.type === 'in') {
                    groupedData[key].checkIn = record.timestamp;
                } else {
                    groupedData[key].checkOut = record.timestamp;
                }
            });
            
            // Calculate hours worked
            Object.values(groupedData).forEach(day => {
                if (day.checkIn && day.checkOut) {
                    const checkInTime = new Date(day.checkIn);
                    const checkOutTime = new Date(day.checkOut);
                    day.hoursWorked = (checkOutTime - checkInTime) / (1000 * 60 * 60); // Convert to hours
                }
            });
            
            return Object.values(groupedData).sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function displayReportPreview(reportData, month, year, employeeId) {
            const previewContainer = document.getElementById('reportPreview');
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let html = `
                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                    Reporte de Asistencia - ${monthNames[month]} ${year}
                    ${employeeId ? ` - ${employees.find(emp => emp.id === employeeId)?.name || 'Empleado no encontrado'}` : ' - Todos los empleados'}
                </h4>
            `;
            
            if (reportData.length === 0) {
                html += '<p class="text-gray-500">No hay datos para el per√≠odo seleccionado</p>';
            } else {
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula/DNI</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrada</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salida</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horas Trabajadas</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                let totalHours = 0;
                
                reportData.forEach(day => {
                    totalHours += day.hoursWorked;
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(day.date).toLocaleDateString('es-ES')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${day.employeeName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${day.employeeId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${day.checkIn ? new Date(day.checkIn).toLocaleTimeString('es-ES') : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${day.checkOut ? new Date(day.checkOut).toLocaleTimeString('es-ES') : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${day.hoursWorked.toFixed(2)} hrs</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-sm font-medium text-gray-900 text-right">Total de horas:</td>
                                <td class="px-6 py-4 text-sm font-bold text-gray-900">${totalHours.toFixed(2)} hrs</td>
                            </tr>
                        </tfoot>
                    </table>
                    </div>
                `;
            }
            
            previewContainer.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }

        function downloadPDF() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const employeeId = document.getElementById('reportEmployee').value;
            
            const reportData = generateReportData(month, year, employeeId);
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.text('Reporte de Asistencia', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Per√≠odo: ${monthNames[month]} ${year}`, 20, 35);
            
            if (employeeId) {
                const employee = employees.find(emp => emp.id === employeeId);
                doc.text(`Empleado: ${employee?.name || 'No encontrado'} (${employeeId})`, 20, 45);
            } else {
                doc.text('Empleado: Todos los empleados', 20, 45);
            }
            
            doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, 20, 55);
            
            if (reportData.length === 0) {
                doc.text('No hay datos para el per√≠odo seleccionado', 20, 75);
            } else {
                // Prepare table data
                const tableData = reportData.map(day => [
                    new Date(day.date).toLocaleDateString('es-ES'),
                    day.employeeName,
                    day.employeeId,
                    day.checkIn ? new Date(day.checkIn).toLocaleTimeString('es-ES') : '-',
                    day.checkOut ? new Date(day.checkOut).toLocaleTimeString('es-ES') : '-',
                    day.hoursWorked.toFixed(2) + ' hrs'
                ]);
                
                const totalHours = reportData.reduce((sum, day) => sum + day.hoursWorked, 0);
                
                // Add table
                doc.autoTable({
                    head: [['Fecha', 'Empleado', 'ID', 'Entrada', 'Salida', 'Horas']],
                    body: tableData,
                    startY: 70,
                    foot: [['', '', '', '', 'Total:', totalHours.toFixed(2) + ' hrs']],
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [59, 130, 246] },
                    footStyles: { fillColor: [243, 244, 246], fontStyle: 'bold' }
                });
            }
            
            // Save PDF
            const fileName = `reporte_asistencia_${monthNames[month]}_${year}${employeeId ? '_' + employeeId : ''}.pdf`;
            doc.save(fileName);
        }

        // Map Selector Functions
        function setupMapSelector() {
            document.getElementById('openMapSelector').addEventListener('click', openMapSelector);
            document.getElementById('closeMapSelector').addEventListener('click', closeMapSelector);
            document.getElementById('cancelMapSelection').addEventListener('click', closeMapSelector);
            document.getElementById('confirmMapSelection').addEventListener('click', confirmMapSelection);
            
            // Map navigation buttons
            document.getElementById('centerMapMontevideo').addEventListener('click', () => centerMap(-34.9058, -56.1913));
            document.getElementById('centerMapPocitos').addEventListener('click', () => centerMap(-34.9176, -56.1565));
            document.getElementById('centerMapCarrasco').addEventListener('click', () => centerMap(-34.8941, -56.0467));
        }

        function openMapSelector() {
            const modal = document.getElementById('mapSelectorModal');
            modal.classList.remove('hidden');
            
            // Initialize map if not already done
            if (!mapInstance) {
                setTimeout(() => {
                    initializeMap();
                }, 100); // Small delay to ensure modal is visible
            }
        }

        function closeMapSelector() {
            const modal = document.getElementById('mapSelectorModal');
            modal.classList.add('hidden');
            
            // Reset selection
            selectedLocation = null;
            document.getElementById('selectedLocationInfo').classList.add('hidden');
            document.getElementById('confirmMapSelection').disabled = true;
            
            // Clear marker if exists
            if (mapInstance && mapInstance.marker) {
                mapInstance.map.removeLayer(mapInstance.marker);
                mapInstance.marker = null;
            }
        }

        function initializeMap() {
            const mapContainer = document.getElementById('leafletMap');
            const loadingIndicator = document.getElementById('mapLoadingIndicator');
            
            try {
                // Create Leaflet map centered on Montevideo
                const map = L.map('leafletMap', {
                    center: [-34.9058, -56.1913], // Montevideo center
                    zoom: 12,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    dragging: true
                });

                // Add OpenStreetMap tiles
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19,
                    minZoom: 10
                });

                tileLayer.addTo(map);

                // Hide loading indicator when tiles are loaded
                tileLayer.on('load', () => {
                    loadingIndicator.style.display = 'none';
                });

                // Add click event listener
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    selectLocationOnMap(lat, lng, map);
                });

                // Store map instance
                mapInstance = { 
                    map: map, 
                    marker: null,
                    tileLayer: tileLayer
                };

                // Force map resize after a short delay
                setTimeout(() => {
                    map.invalidateSize();
                    loadingIndicator.style.display = 'none';
                }, 500);

            } catch (error) {
                console.error('Error initializing map:', error);
                loadingIndicator.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 text-2xl mb-2">‚ö†Ô∏è</div>
                        <p class="text-red-600">Error al cargar el mapa</p>
                        <p class="text-gray-600 text-sm">Verifica tu conexi√≥n a internet</p>
                    </div>
                `;
            }
        }

        function selectLocationOnMap(lat, lng, map) {
            selectedLocation = { lat, lng };
            
            // Remove existing marker if any
            if (mapInstance.marker) {
                map.removeLayer(mapInstance.marker);
            }
            
            // Create custom red marker
            const redIcon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="
                        background-color: #ef4444;
                        width: 20px;
                        height: 20px;
                        border-radius: 50% 50% 50% 0;
                        border: 2px solid white;
                        transform: rotate(-45deg);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            });
            
            // Add new marker
            mapInstance.marker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
            
            // Update UI
            updateSelectedLocationInfo(lat, lng);
        }

        function updateSelectedLocationInfo(lat, lng) {
            const infoDiv = document.getElementById('selectedLocationInfo');
            const coordsSpan = document.getElementById('selectedCoords');
            const addressSpan = document.getElementById('selectedAddress');
            
            coordsSpan.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Try to get address using reverse geocoding
            getAddressFromCoordinates(lat, lng).then(address => {
                addressSpan.textContent = address;
            }).catch(() => {
                // Fallback to neighborhood estimation
                const estimatedAddress = estimateAddress(lat, lng);
                addressSpan.textContent = estimatedAddress;
            });
            
            infoDiv.classList.remove('hidden');
            document.getElementById('confirmMapSelection').disabled = false;
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                // Use Nominatim (OpenStreetMap) reverse geocoding service
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                
                if (!response.ok) {
                    throw new Error('Geocoding service unavailable');
                }
                
                const data = await response.json();
                
                if (data && data.display_name) {
                    // Extract relevant parts of the address
                    const address = data.address || {};
                    const street = address.road || address.pedestrian || '';
                    const houseNumber = address.house_number || '';
                    const neighborhood = address.neighbourhood || address.suburb || address.city_district || '';
                    const city = address.city || address.town || address.village || 'Montevideo';
                    
                    let formattedAddress = '';
                    if (street) {
                        formattedAddress = street;
                        if (houseNumber) {
                            formattedAddress += ` ${houseNumber}`;
                        }
                    }
                    
                    if (neighborhood && neighborhood !== city) {
                        formattedAddress += formattedAddress ? `, ${neighborhood}` : neighborhood;
                    }
                    
                    formattedAddress += formattedAddress ? `, ${city}` : city;
                    
                    return formattedAddress || data.display_name;
                }
                
                throw new Error('No address found');
                
            } catch (error) {
                console.log('Reverse geocoding failed:', error.message);
                throw error;
            }
        }

        function estimateAddress(lat, lng) {
            // Fallback neighborhood estimation for Montevideo
            const neighborhoods = [
                { name: 'Ciudad Vieja', lat: -34.9058, lng: -56.2072, radius: 0.01 },
                { name: 'Centro', lat: -34.9058, lng: -56.1913, radius: 0.015 },
                { name: 'Pocitos', lat: -34.9176, lng: -56.1565, radius: 0.02 },
                { name: 'Carrasco', lat: -34.8941, lng: -56.0467, radius: 0.025 },
                { name: 'Punta Carretas', lat: -34.9239, lng: -56.1645, radius: 0.015 },
                { name: 'Cord√≥n', lat: -34.9089, lng: -56.1847, radius: 0.01 },
                { name: 'Parque Rod√≥', lat: -34.9158, lng: -56.1736, radius: 0.01 },
                { name: 'Tres Cruces', lat: -34.8947, lng: -56.1675, radius: 0.01 },
                { name: 'Buceo', lat: -34.9089, lng: -56.1334, radius: 0.015 },
                { name: 'Malv√≠n', lat: -34.8947, lng: -56.1089, radius: 0.02 }
            ];
            
            for (const neighborhood of neighborhoods) {
                const distance = Math.sqrt(
                    Math.pow(lat - neighborhood.lat, 2) + Math.pow(lng - neighborhood.lng, 2)
                );
                
                if (distance <= neighborhood.radius) {
                    return `${neighborhood.name}, Montevideo`;
                }
            }
            
            return 'Montevideo, Uruguay';
        }

        function centerMap(lat, lng) {
            if (!mapInstance || !mapInstance.map) return;
            
            // Center map on coordinates
            mapInstance.map.setView([lat, lng], 15);
            
            // Select this location
            selectLocationOnMap(lat, lng, mapInstance.map);
        }

        function confirmMapSelection() {
            if (!selectedLocation) return;
            
            const { lat, lng } = selectedLocation;
            
            // Update form fields
            document.getElementById('empLatitude').value = lat.toFixed(6);
            document.getElementById('empLongitude').value = lng.toFixed(6);
            
            // Update address field
            const estimatedAddress = estimateAddress(lat, lng);
            document.getElementById('empAddress').value = estimatedAddress;
            
            // Update neighborhood field
            const neighborhood = estimatedAddress.split(',')[0];
            document.getElementById('empNeighborhood').value = neighborhood;
            
            // Update GPS status indicator
            const statusIndicator = document.getElementById('gpsStatusIndicator');
            const statusIcon = document.getElementById('gpsStatusIcon');
            const statusText = document.getElementById('gpsStatusText');
            const coordinates = document.getElementById('gpsCoordinates');
            
            statusIndicator.className = 'mt-3 p-3 rounded-lg bg-green-100 border border-green-200';
            statusIcon.textContent = 'üó∫Ô∏è';
            statusText.textContent = 'Ubicaci√≥n seleccionada en el mapa';
            coordinates.textContent = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            statusIndicator.classList.remove('hidden');
            
            // Close modal
            closeMapSelector();
            
            showModal(`¬°Ubicaci√≥n seleccionada correctamente!\n\nCoordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nDirecci√≥n estimada: ${estimatedAddress}\n\nPuedes editar la direcci√≥n si lo deseas antes de registrar el empleado.`, 'Ubicaci√≥n Seleccionada', 'success');
        }

        function addSampleData() {
            const sampleEmployees = [
                {
                    id: '12345678', name: 'Mar√≠a Garc√≠a L√≥pez', department: 'Administraci√≥n', position: 'Gerente General', password: '1234',
                    workLocation: { address: '18 de Julio 1234', neighborhood: 'Centro', department: 'Montevideo', latitude: -34.9058, longitude: -56.1913, radius: 100 },
                    registrationDate: new Date().toISOString()
                },
                {
                    id: '87654321', name: 'Carlos Rodr√≠guez', department: 'Empleado', position: 'Ejecutivo Ventas', password: '1234',
                    workLocation: { address: 'Rambla Per√∫ 1234', neighborhood: 'Pocitos', department: 'Montevideo', latitude: -34.9176, longitude: -56.1565, radius: 150 },
                    registrationDate: new Date().toISOString()
                }
            ];
            
            employees = sampleEmployees;
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Add sample records (last 5 days only)
            const sampleRecords = [];
            const today = new Date();
            
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                sampleEmployees.forEach(emp => {
                    const checkIn = new Date(date);
                    checkIn.setHours(8 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 60));
                    
                    sampleRecords.push({
                        id: Date.now() + Math.random(), employeeId: emp.id, employeeName: emp.name, type: 'in',
                        timestamp: checkIn.toISOString(), date: checkIn.toISOString().split('T')[0],
                        location: { latitude: emp.workLocation.latitude, longitude: emp.workLocation.longitude, accuracy: 15 }
                    });
                    
                    const checkOut = new Date(date);
                    checkOut.setHours(17 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 60));
                    
                    sampleRecords.push({
                        id: Date.now() + Math.random(), employeeId: emp.id, employeeName: emp.name, type: 'out',
                        timestamp: checkOut.toISOString(), date: checkOut.toISOString().split('T')[0],
                        location: { latitude: emp.workLocation.latitude, longitude: emp.workLocation.longitude, accuracy: 15 }
                    });
                });
            }
            
            attendanceRecords = sampleRecords;
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            loadEmployeeSelects();
        }

        // Auto-cleanup functions
        function initializeAutoCleanup() {
            // Load cleanup configuration
            document.getElementById('autoCleanupPeriod').value = cleanupConfig.periodDays;
            updateCleanupDisplay();
            
            // Set up automatic cleanup check (every hour)
            cleanupInterval = setInterval(checkAutoCleanup, 60 * 60 * 1000);
            
            // Run initial check
            checkAutoCleanup();
        }

        function checkAutoCleanup() {
            if (!cleanupConfig.enabled || cleanupConfig.periodDays === 0) return;
            
            const now = new Date();
            const cutoffDate = new Date(now.getTime() - (cleanupConfig.periodDays * 24 * 60 * 60 * 1000));
            
            // Check if we need to run cleanup
            if (!cleanupConfig.lastCleanup || new Date(cleanupConfig.lastCleanup) < cutoffDate) {
                const oldRecords = attendanceRecords.filter(record => new Date(record.timestamp) < cutoffDate);
                
                if (oldRecords.length > 0) {
                    console.log(`Auto-cleanup: Found ${oldRecords.length} old records to clean`);
                    performCleanup(cutoffDate, true);
                }
            }
        }

        async function performCleanup(cutoffDate, isAutomatic = false) {
            const oldRecords = attendanceRecords.filter(record => new Date(record.timestamp) < cutoffDate);
            
            if (oldRecords.length === 0) {
                if (!isAutomatic) {
                    await showModal('No hay registros antiguos para eliminar', 'Sin Registros', 'info');
                }
                return;
            }
            
            if (!isAutomatic) {
                showLoading('Ejecutando limpieza...');
            }
            
            try {
                // Remove old records
                attendanceRecords = attendanceRecords.filter(record => new Date(record.timestamp) >= cutoffDate);
                
                // Update storage
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                
                // Update cleanup config
                cleanupConfig.lastCleanup = new Date().toISOString();
                const nextCleanup = new Date();
                nextCleanup.setDate(nextCleanup.getDate() + cleanupConfig.periodDays);
                cleanupConfig.nextCleanup = nextCleanup.toISOString();
                
                localStorage.setItem('cleanupConfig', JSON.stringify(cleanupConfig));
                
                if (!isAutomatic) {
                    await showModal(`‚úÖ Limpieza completada: Se eliminaron ${oldRecords.length} registros antiguos`, 'Limpieza Exitosa', 'success');
                    updateCleanupDisplay();
                    updateCleanupStats();
                    
                    // Refresh attendance display if visible
                    const attendanceSection = document.getElementById('attendanceSection');
                    if (!attendanceSection.classList.contains('hidden')) {
                        displayAttendanceRecords();
                    }
                } else {
                    console.log(`Auto-cleanup completed: Removed ${oldRecords.length} old records`);
                }
            } catch (error) {
                if (!isAutomatic) {
                    await showModal('Error durante la limpieza: ' + error.message, 'Error', 'error');
                }
            } finally {
                if (!isAutomatic) {
                    hideLoading();
                }
            }
        }

        function loadCleanupSection() {
            updateCleanupDisplay();
            updateCleanupStats();
        }

        function updateCleanupDisplay() {
            const lastCleanupEl = document.getElementById('lastCleanupDate');
            const nextCleanupEl = document.getElementById('nextCleanupDate');
            
            if (cleanupConfig.lastCleanup) {
                lastCleanupEl.textContent = new Date(cleanupConfig.lastCleanup).toLocaleString('es-ES');
            } else {
                lastCleanupEl.textContent = 'Nunca ejecutada';
            }
            
            if (cleanupConfig.enabled && cleanupConfig.periodDays > 0) {
                if (cleanupConfig.nextCleanup) {
                    nextCleanupEl.textContent = new Date(cleanupConfig.nextCleanup).toLocaleString('es-ES');
                } else {
                    const nextDate = new Date();
                    nextDate.setDate(nextDate.getDate() + cleanupConfig.periodDays);
                    nextCleanupEl.textContent = nextDate.toLocaleString('es-ES');
                }
            } else {
                nextCleanupEl.textContent = 'Limpieza autom√°tica desactivada';
            }
        }

        function updateCleanupStats() {
            const periodDays = parseInt(document.getElementById('autoCleanupPeriod').value);
            const totalRecordsEl = document.getElementById('totalRecords');
            const oldRecordsEl = document.getElementById('oldRecords');
            const estimatedSizeEl = document.getElementById('estimatedSize');
            
            const totalRecords = attendanceRecords.length;
            totalRecordsEl.textContent = totalRecords.toLocaleString();
            
            if (periodDays > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - periodDays);
                
                const oldRecords = attendanceRecords.filter(record => new Date(record.timestamp) < cutoffDate);
                oldRecordsEl.textContent = oldRecords.length.toLocaleString();
            } else {
                oldRecordsEl.textContent = '0';
            }
            
            // Estimate storage size (rough calculation)
            const estimatedBytes = JSON.stringify(attendanceRecords).length;
            const estimatedKB = Math.round(estimatedBytes / 1024);
            estimatedSizeEl.textContent = estimatedKB + ' KB';
        }

        async function saveCleanupConfig() {
            const periodDays = parseInt(document.getElementById('autoCleanupPeriod').value);
            
            showLoading('Guardando configuraci√≥n...');
            
            try {
                cleanupConfig.enabled = periodDays > 0;
                cleanupConfig.periodDays = periodDays;
                
                if (cleanupConfig.enabled) {
                    const nextCleanup = new Date();
                    nextCleanup.setDate(nextCleanup.getDate() + periodDays);
                    cleanupConfig.nextCleanup = nextCleanup.toISOString();
                } else {
                    cleanupConfig.nextCleanup = null;
                }
                
                localStorage.setItem('cleanupConfig', JSON.stringify(cleanupConfig));
                
                updateCleanupDisplay();
                updateCleanupStats();
                
                await showModal('‚úÖ Configuraci√≥n de limpieza autom√°tica guardada correctamente', 'Configuraci√≥n Guardada', 'success');
            } catch (error) {
                await showModal('Error al guardar configuraci√≥n: ' + error.message, 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        async function runCleanupNow() {
            const periodDays = parseInt(document.getElementById('autoCleanupPeriod').value);
            
            if (periodDays === 0) {
                await showModal('‚ö†Ô∏è La limpieza autom√°tica est√° desactivada. Selecciona un per√≠odo v√°lido.', 'Limpieza Desactivada', 'warning');
                return;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - periodDays);
            
            const oldRecords = attendanceRecords.filter(record => new Date(record.timestamp) < cutoffDate);
            
            if (oldRecords.length === 0) {
                await showModal('‚ÑπÔ∏è No hay registros antiguos para eliminar seg√∫n la configuraci√≥n actual.', 'Sin Registros Antiguos', 'info');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è Se eliminar√°n ${oldRecords.length} registros de asistencia anteriores a ${cutoffDate.toLocaleDateString('es-ES')}.\n\n¬øDesea continuar?`;
            
            const confirmed = await showConfirmModal(confirmMessage, 'Confirmar Limpieza');
            
            if (confirmed) {
                performCleanup(cutoffDate, false);
            }
        }

        function previewCleanup() {
            const periodDays = parseInt(document.getElementById('autoCleanupPeriod').value);
            const previewContainer = document.getElementById('cleanupPreview');
            const previewContent = document.getElementById('cleanupPreviewContent');
            
            if (periodDays === 0) {
                previewContainer.classList.add('hidden');
                showModal('‚ö†Ô∏è La limpieza autom√°tica est√° desactivada. Selecciona un per√≠odo v√°lido.', 'Limpieza Desactivada', 'warning');
                return;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - periodDays);
            
            const oldRecords = attendanceRecords.filter(record => new Date(record.timestamp) < cutoffDate);
            
            if (oldRecords.length === 0) {
                previewContent.innerHTML = '<p class="text-gray-600">No hay registros antiguos para eliminar seg√∫n la configuraci√≥n actual.</p>';
            } else {
                let html = `
                    <div class="mb-4 p-3 bg-yellow-100 rounded-lg">
                        <p class="text-yellow-800 font-medium">
                            Se eliminar√°n ${oldRecords.length} registros anteriores al ${cutoffDate.toLocaleDateString('es-ES')}
                        </p>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Empleado</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${oldRecords.slice(0, 10).map(record => `
                                    <tr>
                                        <td class="px-3 py-2">${new Date(record.timestamp).toLocaleDateString('es-ES')}</td>
                                        <td class="px-3 py-2">${record.employeeName}</td>
                                        <td class="px-3 py-2">${record.type === 'in' ? 'Entrada' : 'Salida'}</td>
                                    </tr>
                                `).join('')}
                                ${oldRecords.length > 10 ? `
                                    <tr>
                                        <td colspan="3" class="px-3 py-2 text-center text-gray-500">
                                            ... y ${oldRecords.length - 10} registros m√°s
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            previewContent.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }

        // Database Management Functions
        function loadDatabaseSection() {
            updateDatabaseStats();
        }

        function updateDatabaseStats() {
            document.getElementById('dbEmployeeCount').textContent = employees.length;
            document.getElementById('dbAttendanceCount').textContent = attendanceRecords.length;
            
            const totalSize = JSON.stringify({employees, attendanceRecords, adminConfig, cleanupConfig}).length;
            document.getElementById('dbSize').textContent = Math.round(totalSize / 1024) + ' KB';
            
            const lastUpdate = localStorage.getItem('lastUpdate') || 'Nunca';
            document.getElementById('dbLastUpdate').textContent = lastUpdate === 'Nunca' ? lastUpdate : new Date(lastUpdate).toLocaleString('es-ES');
        }

        async function exportDatabase() {
            showLoading('Exportando base de datos...');
            
            try {
                const dbData = {
                    employees: employees,
                    attendanceRecords: attendanceRecords,
                    adminConfig: adminConfig,
                    cleanupConfig: cleanupConfig,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(dbData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `entradaya_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                await showModal('‚úÖ Base de datos exportada correctamente', 'Exportaci√≥n Exitosa', 'success');
            } catch (error) {
                await showModal('Error al exportar: ' + error.message, 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        async function exportJSON() {
            await exportDatabase(); // Same functionality
        }

        async function importDatabase() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                await showModal('Por favor selecciona un archivo para importar', 'Archivo Requerido', 'warning');
                return;
            }
            
            const confirmed = await showConfirmModal('‚ö†Ô∏è Esto reemplazar√° todos los datos actuales. ¬øContinuar?', 'Confirmar Importaci√≥n');
            
            if (!confirmed) return;
            
            showLoading('Importando base de datos...');
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Validate data structure
                if (!data.employees || !Array.isArray(data.employees)) {
                    throw new Error('Formato de archivo inv√°lido: falta datos de empleados');
                }
                
                if (!data.attendanceRecords || !Array.isArray(data.attendanceRecords)) {
                    throw new Error('Formato de archivo inv√°lido: falta datos de asistencia');
                }
                
                // Import data
                employees = data.employees;
                attendanceRecords = data.attendanceRecords;
                
                if (data.adminConfig) {
                    adminConfig = data.adminConfig;
                }
                
                if (data.cleanupConfig) {
                    cleanupConfig = data.cleanupConfig;
                }
                
                // Save to localStorage
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                localStorage.setItem('adminConfig', JSON.stringify(adminConfig));
                localStorage.setItem('cleanupConfig', JSON.stringify(cleanupConfig));
                localStorage.setItem('lastUpdate', new Date().toISOString());
                
                // Update UI
                loadEmployeeSelects();
                updateDatabaseStats();
                
                // Clear file input
                fileInput.value = '';
                
                await showModal(`‚úÖ Base de datos importada correctamente\n\nEmpleados: ${employees.length}\nRegistros: ${attendanceRecords.length}`, 'Importaci√≥n Exitosa', 'success');
                
            } catch (error) {
                await showModal('Error al importar: ' + error.message, 'Error de Importaci√≥n', 'error');
            } finally {
                hideLoading();
            }
        }

        async function clearDatabase() {
            const firstConfirm = await showConfirmModal('‚ö†Ô∏è Esto eliminar√° TODOS los datos del sistema. ¬øContinuar?', 'Confirmar Limpieza Total');
            
            if (!firstConfirm) return;
            
            const finalConfirm = await showConfirmModal('üö® CONFIRMACI√ìN FINAL: ¬øEliminar TODA la base de datos?', 'Confirmaci√≥n Final');
            
            if (!finalConfirm) return;
            
            showLoading('Limpiando base de datos...');
            
            try {
                // Clear all data
                employees = [];
                attendanceRecords = [];
                
                // Reset admin config to default
                adminConfig = {
                    password: 'admin123',
                    isDefault: true
                };
                
                // Reset cleanup config
                cleanupConfig = {
                    enabled: true,
                    periodDays: 90,
                    lastCleanup: null,
                    nextCleanup: null
                };
                
                // Clear localStorage
                localStorage.removeItem('employees');
                localStorage.removeItem('attendanceRecords');
                localStorage.removeItem('adminConfig');
                localStorage.removeItem('cleanupConfig');
                localStorage.removeItem('lastUpdate');
                
                // Update UI
                loadEmployeeSelects();
                updateDatabaseStats();
                updateAdminSettingsUI();
                
                await showModal('‚úÖ Base de datos limpiada completamente. Se han restaurado los valores por defecto.', 'Limpieza Completada', 'success');
                
            } catch (error) {
                await showModal('Error al limpiar base de datos: ' + error.message, 'Error', 'error');
            } finally {
                hideLoading();
            }
        }

        function viewDatabaseTable(table) {
            const viewer = document.getElementById('databaseViewer');
            let data, title;
            
            switch(table) {
                case 'employees':
                    data = employees;
                    title = 'Empleados';
                    break;
                case 'attendance':
                    data = attendanceRecords;
                    title = 'Registros de Asistencia';
                    break;
                case 'config':
                    data = {adminConfig, cleanupConfig};
                    title = 'Configuraci√≥n del Sistema';
                    break;
                default:
                    return;
            }
            
            let html = `<h5 class="font-semibold text-gray-900 mb-3">${title}</h5>`;
            
            if (Array.isArray(data) && data.length === 0) {
                html += '<p class="text-gray-600">No hay datos en esta tabla</p>';
            } else {
                html += `<pre class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-64">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            viewer.innerHTML = html;
        }

        async function checkDatabaseIntegrity() {
            showLoading('Verificando integridad...');
            
            try {
                const results = [];
                
                // Check employees
                const duplicateIds = employees.filter((emp, index, arr) => 
                    arr.findIndex(e => e.id === emp.id) !== index
                );
                
                if (duplicateIds.length > 0) {
                    results.push(`‚ùå ${duplicateIds.length} empleados con IDs duplicados`);
                } else {
                    results.push(`‚úÖ No hay IDs de empleados duplicados`);
                }
                
                // Check attendance records
                const orphanRecords = attendanceRecords.filter(record => 
                    !employees.find(emp => emp.id === record.employeeId)
                );
                
                if (orphanRecords.length > 0) {
                    results.push(`‚ö†Ô∏è ${orphanRecords.length} registros de empleados inexistentes`);
                } else {
                    results.push(`‚úÖ Todos los registros tienen empleados v√°lidos`);
                }
                
                // Check data consistency
                const invalidRecords = attendanceRecords.filter(record => 
                    !record.timestamp || !record.employeeId || !record.type
                );
                
                if (invalidRecords.length > 0) {
                    results.push(`‚ùå ${invalidRecords.length} registros con datos incompletos`);
                } else {
                    results.push(`‚úÖ Todos los registros tienen datos completos`);
                }
                
                // Check storage size
                const totalSize = JSON.stringify({employees, attendanceRecords}).length;
                results.push(`üìä Tama√±o total: ${Math.round(totalSize / 1024)} KB`);
                
                document.getElementById('integrityResults').innerHTML = results.join('<br>');
                
            } catch (error) {
                document.getElementById('integrityResults').innerHTML = `‚ùå Error durante la verificaci√≥n: ${error.message}`;
            } finally {
                hideLoading();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9797c50e75a469a7',t:'MTc1NjkyODk2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
